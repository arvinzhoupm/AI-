## 智能硬件 WiFi 配网，你了解多少？

物联网正如火如荼的普及，智能家居/智能硬件类产品，如智能空调、空气净化器、扫地机、家用监控 IPC等等需要与手机/云端进行数据交互。

由于家庭网络 wifi 网络的普及，基本每家都有一台甚至更多的 WiFi 路由器，所以目前，智能设备基本普遍采用 WiFi 与路由器链接完成入网，用户从而获得设备端采集的数据以及对设备进行控制。

但是类似于扫地机、智能空调、IPC 等设备不具备人机交互界面，不像我们的智能手机/笔记本/iPad 等一样能够通过屏幕直接搜索/选择/输入账户名称和密码进行配网。

那我们该如何解决这类设备配网的问题呢？

本文按照概念、原理、流程介绍常见的 WiFi 设备配网方式。

### 01 什么是配网

**狭义上配网**是指 WiFi 终端设备获取路由器的 SSID/password 等信息并与路由器建立链接的过程。

实际上还有一个**绑定**的过程，即将设备与账户发送到云端进行绑定。

我们通常意义上的配网是指将设备接入互联网并与用户的账户进行绑定。

因为，如果只将设备通过路由器接入互联网，没有云端的参与，只能算是完成了一半。

只有将设备归属到用户的账户下，用户才能控制、获取设备数据信息。

举个例子就比较容易明白：小蝌蚪找妈妈

>假设云服务是一个大池塘，终端设备就像一只小蝌蚪，池塘里有很多蝌蚪，当你把小蝌蚪放入池塘中（终端设备联网了），这时候小蝌蚪像个孤儿在池塘里游荡，没有归属。这时候你告诉了蝌蚪妈妈她孩子的名字『晴儿』（MAC 地址），当小蝌蚪在池塘四处游荡的时候，蝌蚪妈妈不停的喊『晴儿』（MAC 地址），小蝌蚪听到后回到妈妈身边，此后小蝌蚪终于不再是流浪儿了。

具体的云端绑定过程不是这样的。但是，大概这么个意思。

**即确定设备归属，用户宣告设备主权。** 而不是一个设备入网之后，谁都能看到该设备。

抛开**绑定**谈**配网**的成功率及用户体验是无效的，因为用户找不到自己的设备，明明设备已经提示连接网络成功，手机端 App 就是没有自己的设备，这是极度影响用户体验的。

另外，还有安全风险，比如有些 IPC 入网之后，别人的在自己的账户下可以看到你的设备，并且能够操控你的设备，能看见你在家里的一举一动。

比如，前段时间 Tesla 事件，好像是美国用户的车辆，出现在欧洲用户账户下，不仅能看到车辆的位置信息、状态信息、点亮信息等，还能控制汽车开关车窗，当然 Tesla 也考虑到安全因素，远程不能开启自动驾驶。

很多时候，我们产品经理在写 PRD 的时候并未写明绑定，因为其实工程师明白其中的过程和技术设计。

具体的云端设计也比较复杂，实际的网络通讯交互内容设计很多，比如产品密匙、产品 ID 等等，这里我们省略云端参与的部分，作为产品经理关注前端的狭义配网，比较其优缺点，根据产品特性和使用环境选择合适的配网方式。

先来看一下简化的配网示意图。

![配网](../picture/文章配图/Wi-Fi%20配网/简化配网过程.png)

市面上常见的配网技术：

1、一键配网（smart config）

2、设备热点配网（AP 配网）

3、蓝牙配网

4、其他（语音识别/扫码识别）

### 02 配网流程及原理

**1、一键配网（smart config）**

**用户流程**

1、用户按设备上的「配网按键」，设备进入混杂监听模式（sniffer）；

2、用户在手机 App 端输入将要连接的路由器 SSID/password 并点击 App 端的「配对按钮」发起配对；

3、此时用户基本啥也不用干了，等着就好。一般情况下终端设备会自动提示设备是否接入网络（比如指示灯/语音提示）；若云端绑定设备成功，App 端会自动显示该设备状态。

**流程示意图**

![smartconfig](../picture/文章配图/Wi-Fi%20配网/smartconfig.png)

**主要的技术原理**

手机通过自身 Wi-Fi 或者路由器发送广播/组播包，也就是包含路由器 SSID 和 password 的信息发送出去。Wi-Fi 终端设备在混杂模式下空中抓取广播/组播包，然后解析获取路由器的 SSID 和 password，然后切换到 station 模式去连接路由器。

**优点**

用户仅需操作 2 步，，配网操作不复杂，操作体验较好。

**缺点**

1、目前几乎所有的智能设备工作在 2.4G 频段下，如果手机当前连接的是路由器的 5G 频段，那么发出去的包也是 5G 的，导致终端设备获取不到广播/组播包；

>这就是为什么明明输入的 wifi SSID 和 password 都是正确的，但是设备总是提示联网失败的大概率原因。

2、某些厂家的路由器默认是关闭广播/组播转发，这样终端设备接收不到报文；

3、大部分路由器不支持局域网通讯，造成手机端收不到终端设备的 MAC 地址，导致绑定失败；

4、如果用户家里有几台路由器，并且使用同样的 SSID 和 Password，导致手机和终端设备不在同一个路由下，也会导致绑定失败。

虽然这种方式配网操作简单，但是配网成功率比较低，无论是因为获取不到 SSID 和 Password 还是无法绑定。并且设备端和手机端还没法进行准确的异常提示。

但这种配网方式还是很多厂商采用，我认为一是物联网很多小玩家在做，没有足够的经验；二是，现存的配网方式还没有谁做的体验比较好。

我使用过很多小米家的产品，他们好像是完全摒弃了 smart config 这种方式，基本采用的是接下来要讲的 AP 配网和蓝牙配网。

**2、设备热点配网（AP 配网）**

**用户流程**

1、用户按终端设备上的「配网按键」，设备进入 AP 模式并且建立一个 AP 热点（设备说明书或者机身标签贴上会写明人点的 SSID 和 Password）；

2、用户手动在手机 Wi-Fi 设置中输入设备热点的 SSID 和 Password 与设备建立连接；或者在 App 中选择 AP 联网模式自动跳转到手机 Wi-Fi 设置界面（Android 可以，但需要设计该功能；iOS 设备不支持）。此操作为手机与设备建立局域网；

3、用户在 App 中输入要连接的路由器 SSID 和 Password 并发送给设备；

4、用户手动将手机 Wi-Fi 网络切回到当前的路由网络中等待设备入网。

**流程示意图**

![AP配网](../picture/文章配图/Wi-Fi%20配网/AP%20配网.png)

**主要技术原理**

Wi-Fi 终端设备进入配网状态，设备启动 AP 模式，也就是相当于路由器，手机连接设备后，将目标路由器的 SSID 和 Password 直接发送给终端设备，同时手机获取设备的 MAC 地址。

设备获得 SSID 和 Password 后切换到 station 模式（即终端模式）去寻找路由器并接入。

手机将 App 账户与 MAC 地址绑定后发送到云端。

**优点**

1、稳定可靠，几乎达到 100% 配对成功率。

2、没有手机和路由器兼容性问题，同时当前环境下，多同名 Wi-Fi 路由器无影响。

**缺点**

1、配对步骤繁复，操作体验不好（对于不是很了解的同学，即使照着说明书操作也可能出错）；

2、当用户输入错误路由器密码的时候，由于手机已经获取了 MAC 地址，此时需要云平台做外网绑定。否则，设备绑定成功，App 可以查到设备，但是设备显示的时候是离线状态。

一般建议采用这种方式进行设备配网，因为 smartconfig 方式经常遭到投诉。目前 AP 配网模式市场也在增长。

**蓝牙配网**

**用户流程**

1、用户按终端设备上的「配对按键」，启动终端设备的 BLE 进入配网状态；

2、用户通过手机蓝牙连接终端设备；

3、用户在手机 App 端输入路由器的 SSID 和 Password ，并点击「配对」向设备发送路由器的 SSID 和 Password；

4、此时，用户可以坐等设备联网了。

**流程示意图**

![蓝牙配网](../picture/文章配图/Wi-Fi%20配网/蓝牙配网.png)

**主要技术原理**

这种方式与 AP 配对模式一样，只不过是将传输路由器 SSID 和 Password 的任务交给 BLE 了而已。

**优点**

用户体验稍好，成功率高。

**缺点**

可以说这是智能硬件的豪华配置，成本较高，因为相对于他配网形式需要增加蓝牙模块的赢家成本。

手机与设备的蓝牙模块的兼容也需要考虑。

**4、其它**

1）语音配网，即使用本地的语音识别能力进行配网。

用户在 App 端输入路由器的 SSID 和 Password 后生成语音，然后启动终端设备的配对模式进行收音并解析，然后联网。

比如：360 的智能门铃使用该方式。

2）二维码扫码配网

同理，用户在 App 端输入路由器的 SSID 和 Password 后生成二维码，然后启动设备配对模式，终端设备的摄像头进行扫码并解析。

比如，小米的智能摄像头。

这两种入网方式用户使用体验非常好，具备此硬件配置的终端设备可以采用对用的方式。可以说是绝佳的体验。

### 03 总结

还有其它的小众配网方式，比如手机热点配网、阿里的零配方式、路由器配网方式。

客诉、退货不少因为配网失败导致。

产品经理在选择合适的配网方式的同时需要做好售后服务的引导工作，产品包设计的时候需要考虑说明书，销售培训材料等等。

在综合成本、技术、用户体验的情况的下进行选择配对成功率高，操作相对简单的配网方式。

既要保证接入网，也需要保证设备绑定的成功率。根据设备属性做好设备权限安全工作。